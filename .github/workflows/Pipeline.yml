name: Verify PoC and Generate Documentation

on:
  push:
  pull_request:

jobs:
  Prepare:
    uses: pyTooling/Actions/.github/workflows/PrepareJob.yml@dev

  Build-OSVVM:
    name: Build OSVVM
    strategy:
      fail-fast: false
      matrix:
        include:
          - {simulator: 'nvc',  backend: 'llvm',  startScript: 'StartNVC.tcl'}
          - {simulator: 'ghdl', backend: 'mcode', startScript: 'StartGHDL.tcl'}
          - {simulator: 'ghdl', backend: 'llvm',  startScript: 'StartGHDL.tcl'}
    runs-on: ubuntu-24.04
    steps:
      - name: ‚è¨ Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: true

      - name: üîß Install tcllib
        run: sudo apt-get install -y --no-install-recommends tcllib

      - name: Setup GHDL ${{ matrix.backend }}
        uses: ghdl/setup-ghdl@v1
        if: matrix.simulator == 'ghdl'
        with:
          version: latest
          backend: ${{ matrix.backend }}

      - name: Setup NVC
        uses: nickg/setup-nvc@v1
        if: matrix.simulator == 'nvc'
        with:
          version: latest

      - name: Prepare
        run: |
          mkdir -p temp/${{ matrix.simulator }}

      - name: üî® Prepare Script
        run: |
          cd temp/${{ matrix.simulator }}

          tee run.tcl <<EOF
          source ../../lib/OSVVM-Scripts/${{ matrix.startScript }}
          build ../../lib/OsvvmLibraries.pro OsvvmLibraries
          EOF

      - name: Precompile OSVVM GHDL
        if: matrix.simulator == 'ghdl'
        run: |
          cd temp/${{ matrix.simulator }}
          tclsh run.tcl

      - name: Precompile OSVVM NVC
        if: matrix.simulator == 'nvc'
        run: |
          cd temp/${{ matrix.simulator }}
          nvc --do run.tcl

      - name: üì§ Upload '${{ matrix.simulator }}-${{ matrix.backend }}-OSVVM-Report' artifacts
        uses: pyTooling/upload-artifact@v4
        continue-on-error: true
        with:
          name: ${{ matrix.simulator }}-${{ matrix.backend }}-OSVVM-Report
          working-directory: temp/${{ matrix.simulator }}
          path: |
            logs
            reports
            *.html
            *.xml
            *.yml
          retention-days: 1

      - name: üì§ Upload '${{ matrix.simulator }}-${{ matrix.backend }}-OSVVM' artifacts
        uses: pyTooling/upload-artifact@v4
        with:
          name: ${{ matrix.simulator }}-${{ matrix.backend }}-OSVVM
          working-directory: temp/${{ matrix.simulator }}
          path: |
            VHDL_LIBS
          retention-days: 1

      - name: üì§ Upload '${{ matrix.simulator }}-${{ matrix.backend }}-OSVVM-Generated' artifacts
        uses: pyTooling/upload-artifact@v4
        continue-on-error: true
        with:
          name: ${{ matrix.simulator }}-${{ matrix.backend }}-OSVVM-Generated
          path: |
            lib/osvvm/*_generated.vhd
          retention-days: 1

  Build-PoC:
    name: Build PoC
    strategy:
      fail-fast: false
      matrix:
        include:
          - {simulator: 'nvc',  backend: 'llvm',  startScript: 'StartNVC.tcl'}
          - {simulator: 'ghdl', backend: 'mcode', startScript: 'StartGHDL.tcl'}
          - {simulator: 'ghdl', backend: 'llvm',  startScript: 'StartGHDL.tcl'}
    runs-on: ubuntu-24.04
    needs:
      - Build-OSVVM
    steps:
      - name: ‚è¨ Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: true

      - name: üîß Install tcllib
        run: sudo apt-get install -y --no-install-recommends tcllib

      - name: Setup GHDL ${{ matrix.backend }}
        uses: ghdl/setup-ghdl@v1
        if: matrix.simulator == 'ghdl'
        with:
          version: latest
          backend: ${{ matrix.backend }}

      - name: Setup NVC
        uses: nickg/setup-nvc@v1
        if: matrix.simulator == 'nvc'
        with:
          version: latest

      - name: Prepare
        run: |
          mkdir -p temp/${{ matrix.simulator }}

          mv src/common/my_project.vhdl.template tb/common/my_project.vhdl

      - name: üì• Download artifacts '${{ matrix.simulator }}-${{ matrix.backend }}-OSVVM' from 'Build-OSVVM' job
        uses: pyTooling/download-artifact@v4
        with:
          name: ${{ matrix.simulator }}-${{ matrix.backend }}-OSVVM
          path: temp/${{ matrix.simulator }}

      - name: üì• Download artifacts '${{ matrix.simulator }}-${{ matrix.backend }}-OSVVM-Generated' from 'Build-OSVVM' job
        uses: pyTooling/download-artifact@v4
        with:
          name: ${{ matrix.simulator }}-${{ matrix.backend }}-OSVVM-Generated

      - name: üî® Generate run.tcl for pre-compile
        run: |
          ls -lAh lib/osvvm/*_generated.vhd

          cd temp/${{ matrix.simulator }}

          tee run.tcl <<EOF
          source ../../lib/OSVVM-Scripts/${{ matrix.startScript }}

          namespace eval ::poc {
            variable myConfigFile  "../tb/common/my_config_GENERIC.vhdl"
            variable myProjectFile "../tb/common/my_project.vhdl"
            variable vendor        "GENERIC";                               # GENERIC for vendor-less build; Xilinx, Altera,... for vendor specific build
          }

          if {$::osvvm::ToolName eq "GHDL"} {
            SetExtendedAnalyzeOptions {-frelaxed -Wno-specs -Wno-elaboration}
          }

          if {$::osvvm::ToolName eq "NVC"} {
            SetExtendedAnalyzeOptions {--relaxed}
          }

          build ../../src/PoC.pro PoC
          EOF

      - name: Precompile PoC GHDL
        if: matrix.simulator == 'ghdl'
        run: |
          cd temp/${{ matrix.simulator }}
          tclsh run.tcl

      - name: Precompile PoC NVC
        if: matrix.simulator == 'nvc'
        run: |
          cd temp/${{ matrix.simulator }}
          nvc --do run.tcl


      - name: üìà Generate run.tcl for simulate
        if: always()
        run: |
          cd temp/${{ matrix.simulator }}

          tee run2.tcl <<EOF
          source ../../lib/OSVVM-Scripts/${{ matrix.startScript }}

          namespace eval ::poc {
            variable myConfigFile  "../tb/common/my_config_GENERIC.vhdl"
            variable myProjectFile "../tb/common/my_project.vhdl"
            variable vendor        "GENERIC";                               # GENERIC for vendor-less build; Xilinx, Altera,... for vendor specific build
          }

          if {$::osvvm::ToolName eq "GHDL"} {
            SetExtendedSimulateOptions {-frelaxed -Wno-specs -Wno-binding}
          }

          if {$::osvvm::ToolName eq "NVC"} {
          }

          build ../../tb/RunAllTests.pro
          EOF

      - name: Simulate PoC GHDL
        if: matrix.simulator == 'ghdl'
        run: |
          cd temp/${{ matrix.simulator }}
          tclsh run2.tcl

      - name: Simulate PoC NVC
        if: always() && matrix.simulator == 'nvc'
        run: |
          cd temp/${{ matrix.simulator }}
          nvc --do run2.tcl

      - name: üì§ Upload '${{ matrix.simulator }}-${{ matrix.backend }}-PoC-Report' artifacts
        if: always()
        uses: pyTooling/upload-artifact@v4
        continue-on-error: true
        with:
          name: ${{ matrix.simulator }}-${{ matrix.backend }}-PoC-Report
          working-directory: temp/${{ matrix.simulator }}
          path: |
            logs
            reports
            *.html
            *.yml
          retention-days: 1

      - name: üì§ Upload '${{ matrix.simulator }}-${{ matrix.backend }}-PoC-Report-XML' artifacts
        if: always()
        uses: pyTooling/upload-artifact@v4
        continue-on-error: true
        with:
          name: ${{ matrix.simulator }}-${{ matrix.backend }}-PoC-Report-XML
          working-directory: temp/${{ matrix.simulator }}
          path: |
            *.xml
          retention-days: 1

      - name: üì§ Upload '${{ matrix.simulator }}-${{ matrix.backend }}-PoC' artifacts
        if: always()
        uses: pyTooling/upload-artifact@v4
        with:
          name: ${{ matrix.simulator }}-${{ matrix.backend }}-PoC
          working-directory: temp/${{ matrix.simulator }}
          path: |
            VHDL_LIBS
          retention-days: 1

  Documentation:
    uses: pyTooling/Actions/.github/workflows/SphinxDocumentation.yml@r5
    needs:
      - Build-PoC
    if: success() || failure()
    with:
      requirements:          '-r docs/requirements.txt'
      doc_directory:         'docs'
      unittest_xml_artifact: 'ghdl-llvm-PoC-Report-XML'
      html_artifact:         'PoC-HTML'
      latex_artifact:        'PoC-LaTeX'

  PublishToGitHubPages:
    uses: pyTooling/Actions/.github/workflows/PublishToGitHubPages.yml@r5
    needs:
      - Documentation
      - Build-PoC
    if: success() || failure()
    with:
      doc:      'PoC-HTML'
#      coverage: 'PoC-Coverage-HTML'

  AutoTag:
    uses: pyTooling/Actions/.github/workflows/TagReleaseCommit.yml@r5
    needs:
      - Prepare
      - PublishToGitHubPages
    if: needs.Prepare.outputs.is_release_commit && github.event_name != 'schedule'
    permissions:
      contents: write  # required for create tag
      actions:  write  # required for trigger workflow
    with:
      version:  ${{ needs.Prepare.output.version }}
      auto_tag: ${{ needs.Prepare.outputs.is_release_commit }}

  Release:
    uses: pyTooling/Actions/.github/workflows/PublishReleaseNotes.yml@r5
    needs:
      - PublishToGitHubPages
    if: needs.Prepare.outputs.is_release_tag == 'true'
    permissions:
      contents: write
      actions:  write
    with:
      prerelease: true
      replacements: |
        poc=${{ needs.Prepare.outputs.version }}
      tag: ${{ needs.Prepare.outputs.version }}
      description: |
        # The PoC-Library %poc%
      inventory-json: "inventory.json"
      inventory-version: ${{ needs.Prepare.outputs.version }}
      assets: |

    secrets: inherit
